Name: abc-edges
Processes: 1
Steps:
    network:
        Extension: gml
        Parameters:
            nnode: 5000
            mean_degree: [2, 5, 8]
            seed: 0
        Interpreter: R --vanilla --silent
        Startup: |
            suppressPackageStartupMessages(library(netabc))
            suppressPackageStartupMessages(library(igraph))
        Rule: | 
            set.seed({seed} + {mean_degree})
            g <- sample_gnp({nnode}, {mean_degree}/{nnode})
            graph_attr(g, "comment") <- "{yaml}"
            write.graph(SI.net(g), "{network}", format="gml")

    tree:
        Extension: nwk
        Parameters:
            nnode: 5000
            mean_degree: [2, 5, 8]
            seed: 0
            nsimnode: 1000
            ntip: 1000
        Depends: network
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {tree}
            nettree --sim-nodes {nsimnode} --tree-tips {ntip} --seed `echo {seed}+{mean_degree} | bc` {network} >> {tree}
            i=0
            while [[ `treestat -i -s ntip {tree}` -lt {ntip} ]]; do
                echo "#{yaml}" > {tree}
                nettree --sim-nodes {nsimnode} --tree-tips {ntip} --seed `echo {seed}+{mean_degree}+$i | bc` {network} >> {tree}
                i=$(($i+1))
            done

    abc-config:
        Extension: yaml
        Parameters:
            nnode: 5000
            nsimnode: 1000
            mean_degree_min: 1
            mean_degree_max: 12
        Interpreter: bash
        Rule: |
            echo "nodes: {nnode}" > {abc-config}
            echo "sim_nodes: {nsimnode}" >> {abc-config}
            EDGE_DENSITY_MIN=`echo {mean_degree_min}/{nnode} | bc -l`
            EDGE_DENSITY_MAX=`echo {mean_degree_max}/{nnode} | bc -l`
            echo "edges: [\"uniform\", $EDGE_DENSITY_MIN, $EDGE_DENSITY_MAX]" >> {abc-config}

    abc:
        Extension: tsv
        Processes: 1
        Parameters:
            nnode: 5000
            mean_degree: [2, 5, 8]
            seed: 0
            nsimnode: 1000
            ntip: 1000
            nthread: 20
            decay_factor: 0.3
            rbf_variance: 10
            nparticle: 2000
            nsample: 10
            quality: 0.95
            mean_degree_min: 1
            mean_degree_max: 12
        Depends: tree abc-config
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {abc}
            netabc --num-threads {nthread} --decay-factor {decay_factor} \
                   --rbf-variance {rbf_variance} --num-particles {nparticle} \
                   --num-samples {nsample} --quality {quality} {tree} {abc-config} >> {abc}

    density-plot:
        Extension: pdf
        Parameters:
            nnode: 5000
            mean_degree: [2, 5, 8]
        Depends: abc
        Interpreter: R --vanilla --silent
        Startup: library(yaml)
        Rule: |
            yaml <- "{yaml}"
            p <- read.table("{abc}")[,1]
            pdf("{density-plot}")
            plot(density(p), xlab="edges", ylab="posterior density",
                 main=paste(strwrap(as.yaml(yaml.load(yaml)), 60), collapse="\n"))
            abline(v={mean_degree}/{nnode}, col="red")
            dev.off()
