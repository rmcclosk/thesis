Name: gridsearch-smallworld
Description: Grid search for small world rewiring probability
Processes: 20
Steps:
    train-network:
        Extension: gml
        Parameters:
            nnode: 5000
            nbhd_size: 2
            rewire_prob: "[i/1000 for i in range(101)]"
            replicate: "range(10)"
        Interpreter: R --vanilla --silent
        Startup: suppressPackageStartupMessages(library(netabc))
        Rule: | 
            set.seed({seed})
            g <- sample_smallworld(1, {nnode}, {nbhd_size}, {rewire_prob})
            graph_attr(g, "comment") <- "{yaml}"
            write.graph(SI.net(g), "{train-network}", format="gml")

    train-tree:
        Extension: nwk
        Parameters:
            rewire_prob: "[i/1000 for i in range(101)]"
            replicate: "range(10)"
            nsimnode: 1000
            ntip: 1000
        Depends: train-network
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {train-tree}                                                 
            nettree --sim-nodes {nsimnode} --tree-tips {ntip} --seed {seed} {train-network} >> {train-tree}

    test-network:
        Extension: gml
        Parameters:
            nnode: 5000
            nbhd_size: 2
            true_rewire_prob: [0.01, 0.05, 0.09]
            test_replicate: "range(10)"
        Interpreter: R --vanilla --silent
        Startup: suppressPackageStartupMessages(library(netabc))
        Rule: | 
            set.seed({seed})
            g <- sample_smallworld(1, {nnode}, {nbhd_size}, {true_rewire_prob})
            graph_attr(g, "comment") <- "{yaml}"
            write.graph(SI.net(g), "{test-network}", format="gml")

    test-tree:
        Extension: nwk
        Parameters:
            true_rewire_prob: [0.01, 0.05, 0.09]
            test_replicate: "range(10)"
            nsimnode: 1000
            ntip: 1000
        Depends: test-network
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {test-tree}                                                 
            nettree --sim-nodes {nsimnode} --tree-tips {ntip} --seed {seed} {test-network} >> {test-tree}

    kernel:
        Extension: tsv
        Parameters:
            true_rewire_prob: [0.01, 0.05, 0.09]
            test_replicate: "range(10)"
            decay_factor: 0.3
            rbf_variance: 20
        Depends: train-tree test-tree
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {kernel}
            for T in {train-tree}; do
                echo -n "$T"$'\t' >> {kernel}
                treekernel --ladderize --normalize --scale-branches mean \
                           --decay-factor {decay_factor} \
                           --gauss-factor {rbf_variance} \
                           {test-tree} $T >> {kernel}
            done

    kernel-plot:
        Extension: pdf
        Parameters:
            true_rewire_prob: [0.01, 0.05, 0.09]
            test_replicate: "range(10)"
        Depends: kernel train-tree
        Interpreter: R --quiet --vanilla
        Startup: suppressPackageStartupMessages(library(netabc))
        Rule: |
            k <- read.table("{kernel}", row.names=1, col.names=c("", "score"))
            k <- merge(k, collect.metadata(strsplit("{train-tree}", " ")[[1]]), by=0)
            best <- with(k, k[score > quantile(score, 0.95), "rewire_prob"])
            ggplot(k, aes(x=rewire_prob, y=score)) + geom_smooth() +
                geom_vline(xintercept=range(best), col="red") +
                geom_vline(xintercept={true_rewire_prob}, linetype=2) +
                theme_bw()
            ggsave("{kernel-plot}")

    accuracy:
        Extension: tsv
        Parameters:
            placeholder: 0
        Depends: kernel test-tree
        Interpreter: R --quiet --vanilla
        Startup: suppressPackageStartupMessages(library(netabc))
        Rule: |
            d <- collect.data("{kernel}", header=FALSE, row.names=1, col.names=c("", "score"))
            m <- collect.metadata(strsplit("{test-tree}", " ")[[1]])
