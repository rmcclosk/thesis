Name: pcbr-bctree
Processes: 16
Steps:
    tree:
        Extension: nwk
        ExternalFile: timetree

    clustering:
        Extension: tsv
        Parameters:
            nrates: [2, 3, 4]
            bg_rates: [1, 2, 3]
            ubound_branch: [1, 0.143, 0.0333]
            ubound_trans: [1, 0.143, 0.0333]
            use_tips: ["no", "yes"]
            trans_at_nodes: ["no", "yes"]
        Exclusions:
            -
                nrates: 2
                bg_rates: [2, 3, 4]
            -
                nrates: 3
                bg_rates: [3, 4]
            -
                nrates: 4
                bg_rates: 4
        Depends: tree
        Interpreter: bash
        Rule: |
            echo stopTolFun 10 > cmaes.par
            echo stopTolFunHist 10 >> cmaes.par
            echo "#{yaml}" > {clustering}
            if [[ "x{trans_at_nodes}" == "xyes" ]]; then
                if [[ "x{use_tips}" == "xyes" ]]; then
                    pcbr -c cmaes.par --ubound-branch {ubound_branch} --ubound-trans {ubound_trans} --rates {nrates} --bg-states {bg_rates} {tree} >> {clustering}
                else
                    pcbr -c cmaes.par --ubound-branch {ubound_branch} --ubound-trans {ubound_trans} --rates {nrates} --bg-states {bg_rates} --ignore-tips {tree} >> {clustering}
                 fi
            else
                if [[ "x{use_tips}" == "xyes" ]]; then
                    pcbr -c cmaes.par --ubound-branch {ubound_branch} --ubound-trans {ubound_trans} --trans-at-nodes --rates {nrates} --bg-states {bg_rates} {tree} >> {clustering}
                else
                    pcbr -c cmaes.par --ubound-branch {ubound_branch} --ubound-trans {ubound_trans} --trans-at-nodes --rates {nrates} --bg-states {bg_rates} --ignore-tips {tree} >> {clustering}
                fi
            fi

    pcbr-plot:
        Extension: pdf
        Parameters:
            nrates: [2, 3, 4, 5]
            bg_rates: [1, 2, 3, 4]
            ubound_branch: [1, 0.143, 0.0333]
            ubound_trans: [1, 0.143, 0.0333]
            use_tips: ["yes", "no"]
            trans_at_nodes: ["yes", "no"]
        Depends: tree clustering
        Interpreter: R --vanilla --silent
        Rule: |
            library(netabc)
            t <- read.tree("{tree}")
            d <- read.table("{clustering}")
            pdf("{pcbr-plot}")
            par(mar=c(0, 0, 4, 0) + 0.1)
            pcbr.plot(t, d, yaml="{yaml}", direction="down", show.tip.label=FALSE)
