Name: pcbr-validation
Processes: 1
Steps:
    network:
        Extension: gml
        Parameters:
            nnode: 5000
            mean_degree: 8
            seed: !!python/object/apply:__builtin__.xrange [0, 100, 1]
            num_clusters: [2, 10, 20]
            cluster_size: [5, 10, 50, 100]
            cluster_rate: 4
            connect: "TRUE"
        Interpreter: R --vanilla --silent
        Startup: |
            suppressPackageStartupMessages(library(netabc))
            suppressPackageStartupMessages(library(igraph))
        Rule: |
            set.seed({seed})
            g <- barabasi.game({nnode}, m={mean_degree}/2, directed=F)
            graph_attr(g, "comment") <- "{yaml}"
            g <- add.transmission.clusters(g, {cluster_size}, {num_clusters}, {cluster_rate}, {connect})
            write.graph(SI.net(g), "{network}", format="gml")

    tree:
        Extension: nwk
        Parameters:
            nnode: 5000
            mean_degree: 8
            seed: !!python/object/apply:__builtin__.xrange [0, 100, 1]
            num_clusters: [2, 10, 20]
            cluster_size: [5, 10, 50, 100]
            cluster_rate: 4
            connect: "TRUE"
            nsimnode: 1000
            tree_tips: 200
        Depends: network
        Interpreter: bash
        Rule: |
            echo "#{yaml}" > {tree}
            nettree --sim-nodes {nsimnode} --tree-tips {tree_tips} --seed {seed} {network} >> {tree}

    clustering:
        Extension: tsv
        Parameters:
            nrates: 2
            use_tips: no
            trans_per_branch: any
            tip_pdf: no
            cheating: no
            nnode: 5000
            mean_degree: 8
            seed: !!python/object/apply:__builtin__.xrange [0, 100, 1]
            num_clusters: [2, 10, 20]
            cluster_size: [5, 10, 50, 100]
            cluster_rate: 4
            connect: "TRUE"
            nsimnode: 1000
            tree_tips: 200
        Depends: tree
        Interpreter: bash
        Rule: |
            if [[ "x{cheating}" == "xyes" ]]; then
                if [[ "x{tip_pdf}" == "xyes" ]]; then
                    pcbr --rates {nrates} --use-tips {use_tips} --trans-per-branch {trans_per_branch} \
                         --tip-pdf --cheating --newick-outfile /dev/null \
                         --cluster-outfile {clustering} {tree}
                else
                    pcbr --rates {nrates} --use-tips {use_tips} --trans-per-branch {trans_per_branch} \
                         --cheating --newick-outfile /dev/null \
                         --cluster-outfile {clustering} {tree}
                fi
            else
                if [[ "x{tip_pdf}" == "xyes" ]]; then
                    pcbr --rates {nrates} --use-tips {use_tips} --trans-per-branch {trans_per_branch} \
                         --tip-pdf --newick-outfile /dev/null \
                         --cluster-outfile {clustering} {tree}
                else
                    pcbr --rates {nrates} --use-tips {use_tips} --trans-per-branch {trans_per_branch} \
                         --cheating --newick-outfile /dev/null \
                         --cluster-outfile {clustering} {tree}
                fi
            fi
            TMPFILE=/tmp/{clustering}
            echo "#{yaml}" > $TMPFILE
            cat {clustering} >> $TMPFILE
            mv $TMPFILE {clustering}
            rm $TMPFILE
